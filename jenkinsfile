pipeline {
    options { skipDefaultCheckout() }
    agent {label 'Built-InNode'}
    stages {
        stage('BUILD & Push Image to azure') {
            steps {
                script{
                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'containerpassregistry',
                    usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
                        env.REG_USERNAME = USERNAME
                        env.REG_PASSWORD = PASSWORD
                    }
                    checkout scm
                    sh'''
                    pwd
                    whoami
                    docker --version
                    set +x
                    docker login --username=${REG_USERNAME} --password=${REG_PASSWORD}  containerpassregistry.azurecr.io
                    set -x
                    '''
                    echo "#################### Starting ...  #################"
                    echo "#################### Build Images  #################"
                    sh '''
                    export mvnHome = tool 'Maven3.8.6'
                    export mvnCMD ="${mvnHome}/bin/mvn"
                    ${mvnHome}/bin/mvn clean install -f shopfront/pom.xml
                    echo "#################### Tag & Push Image search to azurecr.io #################"

                    docker tag shopfront:1.0 containerpassregistry.azurecr.io/shopfront:1.0
                    docker push containerpassregistry.azurecr.io/shopfront:1.0
                    '''

                }
            }


        }

    }
}
